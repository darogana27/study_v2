<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PFC - æ±äº¬é§è¼ªå ´æ¤œç´¢</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #f5f5f5;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            height: 60px;
            background: #2c3e50;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
        }

        .header-subtitle {
            margin-left: 20px;
            opacity: 0.8;
            font-size: 14px;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
        }

        /* å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆã‚¨ãƒªã‚¢é¸æŠã‚¿ãƒ–ï¼‰ */
        .left-sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            background: #34495e;
            color: white;
        }

        .sidebar-title {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .sidebar-subtitle {
            font-size: 12px;
            opacity: 0.8;
        }

        .area-tabs {
            flex: 1;
            overflow-y: auto;
        }

        .tab-group {
            border-bottom: 1px solid #eee;
        }

        .tab-group-header {
            background: #ecf0f1;
            padding: 12px 20px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
            cursor: pointer;
            user-select: none;
        }

        .tab-group-header:hover {
            background: #d5dbdb;
        }

        .tab-items {
            display: none;
        }

        .tab-items.active {
            display: block;
        }

        .tab-item {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
            transition: all 0.2s ease;
        }

        .tab-item:hover {
            background: #f8f9fa;
            padding-left: 25px;
        }

        .tab-item.selected {
            background: #3498db;
            color: white;
        }

        .tab-item.selected:hover {
            background: #2980b9;
        }

        /* ä¸­å¤®ãƒãƒƒãƒ—ã‚¨ãƒªã‚¢ */
        .map-container {
            flex: 1;
            position: relative;
        }

        .main-container.chat-collapsed .map-container {
            width: 100%;
            margin-right: 0;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .current-area {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .area-info {
            font-size: 12px;
            color: #7f8c8d;
        }

        /* å³ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆãƒãƒ£ãƒƒãƒˆï¼‰ */
        .right-sidebar {
            width: 400px;
            background: white;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            position: relative;
            height: calc(100vh - 60px);
        }

        .sidebar-toggle {
            position: absolute;
            top: 50%;
            left: -15px;
            transform: translateY(-50%);
            background: #27ae60;
            color: white;
            border: none;
            width: 30px;
            height: 60px;
            border-radius: 15px 0 0 15px;
            cursor: pointer;
            font-size: 16px;
            z-index: 1001;
            transition: all 0.3s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            padding: 0;
        }

        .sidebar-toggle:hover {
            background: #219a52;
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        }

        .right-sidebar {
            transition: width 0.3s ease-in-out, background 0.3s ease-in-out, border 0.3s ease-in-out;
        }

        .right-sidebar.collapsed {
            width: 0;
            min-width: 0;
            overflow: visible;
            background: transparent;
            border: none;
        }

        .right-sidebar.collapsed .sidebar-toggle {
            right: 20px;
            bottom: 80px;
            left: auto;
            top: auto;
            transform: none;
            border-radius: 25px;
            width: auto;
            min-width: 120px;
            height: 50px;
            background: #3498db;
            animation: bounce 3s infinite;
            position: fixed;
            z-index: 9999;
            font-size: 14px;
            font-weight: 600;
            padding: 0 15px;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        }

        .right-sidebar.collapsed .sidebar-toggle:hover {
            background: #2980b9;
            transform: translateY(-5px) scale(1.05);
        }

        .right-sidebar.collapsed .chat-header,
        .right-sidebar.collapsed .chat-tabs,
        .right-sidebar.collapsed .chat-messages,
        .right-sidebar.collapsed .chat-input {
            display: none;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(52, 152, 219, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(52, 152, 219, 0);
            }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        .sidebar-toggle-icon {
            transition: all 0.3s ease;
        }

        .chat-header {
            padding: 15px 20px 10px 20px;
            background: #27ae60;
            color: white;
            position: relative;
        }

        .chat-title {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .chat-subtitle {
            font-size: 12px;
            opacity: 0.8;
        }

        /* ãƒãƒ£ãƒƒãƒˆã‚¿ãƒ– */
        .chat-tabs {
            background: #ecf0f1;
            border-bottom: 1px solid #bdc3c7;
            display: flex;
            overflow-x: auto;
            padding: 0 20px;
        }

        .chat-tab {
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            font-size: 12px;
            background: #bdc3c7;
            color: #2c3e50;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s ease;
        }

        .chat-tab.active {
            background: white;
            color: #27ae60;
            font-weight: 600;
        }

        .chat-tab:hover {
            background: #d5dbdb;
        }

        .chat-tab.active:hover {
            background: white;
        }

        .tab-close {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
            color: #e74c3c;
            cursor: pointer;
            font-weight: bold;
            padding: 0;
            margin-left: 8px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s ease;
            opacity: 0.7;
        }

        .tab-close:hover {
            background: #e74c3c;
            color: white;
            opacity: 1;
            transform: scale(1.1);
            box-shadow: 0 2px 4px rgba(231, 76, 60, 0.3);
        }

        .chat-tab:hover .tab-close {
            opacity: 1;
        }

        /* ã‚¿ãƒ–å‰Šé™¤ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .tab-removing {
            animation: tabSlideOut 0.3s ease-out forwards;
        }

        @keyframes tabSlideOut {
            from {
                opacity: 1;
                transform: translateX(0);
                max-width: 200px;
            }
            to {
                opacity: 0;
                transform: translateX(-20px);
                max-width: 0;
                padding: 0;
                margin: 0;
            }
        }

        .new-chat-tab {
            padding: 10px 15px;
            cursor: pointer;
            color: #27ae60;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            margin-left: auto;
        }

        .new-chat-tab:hover {
            background: #d5dbdb;
            border-radius: 8px;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            animation: fadeInUp 0.3s ease;
        }

        .message.bot {
            text-align: left;
        }

        .message.user {
            text-align: right;
        }

        .message-content {
            display: inline-block;
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .message.bot .message-content {
            background: white;
            color: #2c3e50;
        }

        .message.user .message-content {
            background: #3498db;
            color: white;
        }

        .chat-input {
            padding: 20px;
            border-top: 1px solid #ddd;
            background: white;
        }

        .input-container {
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
            font-size: 14px;
        }

        .message-input:focus {
            border-color: #3498db;
        }

        .send-button {
            padding: 12px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
        }

        .send-button:hover {
            background: #2980b9;
        }

        /* é¸æŠè‚¢ãƒœã‚¿ãƒ³ */
        .chat-options {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .option-button {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            font-size: 14px;
            color: #495057;
        }

        .option-button:hover {
            background: #e9ecef;
            border-color: #3498db;
            transform: translateY(-1px);
        }

        .option-button.selected {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        /* ç›®çš„åœ°å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
        .destination-input {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            outline: none;
            width: 100%;
            font-size: 14px;
        }

        .destination-input:focus {
            border-color: #3498db;
        }

        .confirm-button {
            margin-top: 10px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .confirm-button:hover {
            background: #219a52;
        }

        /* é§è¼ªå ´ãƒªã‚¹ãƒˆï¼ˆãƒãƒ£ãƒƒãƒˆå†…ï¼‰ */
        .parking-list {
            margin-top: 15px;
        }

        .parking-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .parking-card:hover {
            border-color: #3498db;
            transform: translateY(-1px);
        }

        .parking-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .parking-info {
            font-size: 12px;
            color: #7f8c8d;
            display: flex;
            justify-content: space-between;
        }

        .priority-tag {
            display: inline-block;
            background: #e74c3c;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
        }

        .priority-tag.price {
            background: #f39c12;
        }

        .priority-tag.availability {
            background: #27ae60;
        }

        .priority-tag.distance {
            background: #3498db;
        }

        /* å·¦ä¸‹å›ºå®šåºƒå‘Š */
        .bottom-left-ad {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 250px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            overflow: hidden;
            z-index: 1000;
            animation: slideInLeft 0.5s ease-out;
        }

        .ad-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .ad-close:hover {
            background: rgba(0,0,0,0.7);
        }

        .ad-content-small {
            display: flex;
            padding: 10px;
            align-items: center;
        }

        .small-ad-image {
            width: 60px;
            height: 40px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 10px;
        }

        .small-ad-text {
            flex: 1;
        }

        .small-ad-text h5 {
            margin: 0 0 5px 0;
            font-size: 12px;
            color: #2c3e50;
            font-weight: 600;
        }

        .small-ad-text p {
            margin: 0 0 8px 0;
            font-size: 10px;
            color: #7f8c8d;
            line-height: 1.3;
        }

        .small-ad-button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 10px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .small-ad-button:hover {
            background: #c0392b;
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 1024px) {
            .left-sidebar {
                width: 250px;
            }
            .right-sidebar {
                width: 350px;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .left-sidebar,
            .right-sidebar {
                width: 100%;
                height: 200px;
            }
            
            .map-container {
                flex: 1;
                min-height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
        <div class="logo">ğŸš² PFC</div>
        <div class="header-subtitle">æ±äº¬é§è¼ªå ´æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="main-container chat-collapsed">
        <!-- å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆã‚¨ãƒªã‚¢é¸æŠï¼‰ -->
        <div class="left-sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">ğŸ“ ã‚¨ãƒªã‚¢é¸æŠ</div>
                <div class="sidebar-subtitle">åœ°åŸŸã‚’é¸æŠã—ã¦ãã ã•ã„</div>
            </div>
            
            <div class="area-tabs">
                <!-- ä¸»è¦é§…å‘¨è¾º -->
                <div class="tab-group">
                    <div class="tab-group-header" onclick="toggleTabGroup(this)">
                        ğŸš‰ ä¸»è¦é§…å‘¨è¾º
                    </div>
                    <div class="tab-items">
                        <div class="tab-item" data-area="shinjuku">ğŸ¢ æ–°å®¿é§…å‘¨è¾º</div>
                        <div class="tab-item" data-area="shibuya">ğŸŒ æ¸‹è°·é§…å‘¨è¾º</div>
                        <div class="tab-item" data-area="ikebukuro">ğŸ›ï¸ æ± è¢‹é§…å‘¨è¾º</div>
                        <div class="tab-item" data-area="tokyo">ğŸ¯ æ±äº¬é§…å‘¨è¾º</div>
                        <div class="tab-item" data-area="shinagawa">ğŸš… å“å·é§…å‘¨è¾º</div>
                        <div class="tab-item" data-area="ueno">ğŸŒ¸ ä¸Šé‡é§…å‘¨è¾º</div>
                    </div>
                </div>

                <!-- 23åŒº -->
                <div class="tab-group">
                    <div class="tab-group-header" onclick="toggleTabGroup(this)">
                        ğŸ™ï¸ æ±äº¬23åŒº
                    </div>
                    <div class="tab-items">
                        <div class="tab-item" data-area="chiyoda">åƒä»£ç”°åŒº</div>
                        <div class="tab-item" data-area="chuo">ä¸­å¤®åŒº</div>
                        <div class="tab-item" data-area="minato">æ¸¯åŒº</div>
                        <div class="tab-item" data-area="shinjuku_ward">æ–°å®¿åŒº</div>
                        <div class="tab-item" data-area="bunkyo">æ–‡äº¬åŒº</div>
                        <div class="tab-item" data-area="taito">å°æ±åŒº</div>
                        <div class="tab-item" data-area="sumida">å¢¨ç”°åŒº</div>
                        <div class="tab-item" data-area="koto">æ±Ÿæ±åŒº</div>
                        <div class="tab-item" data-area="shinagawa_ward">å“å·åŒº</div>
                        <div class="tab-item" data-area="meguro">ç›®é»’åŒº</div>
                        <div class="tab-item" data-area="ota">å¤§ç”°åŒº</div>
                        <div class="tab-item" data-area="setagaya">ä¸–ç”°è°·åŒº</div>
                        <div class="tab-item" data-area="shibuya_ward">æ¸‹è°·åŒº</div>
                        <div class="tab-item" data-area="nakano">ä¸­é‡åŒº</div>
                        <div class="tab-item" data-area="suginami">æ‰ä¸¦åŒº</div>
                        <div class="tab-item" data-area="toshima">è±Šå³¶åŒº</div>
                        <div class="tab-item" data-area="kita">åŒ—åŒº</div>
                        <div class="tab-item" data-area="arakawa">è’å·åŒº</div>
                        <div class="tab-item" data-area="itabashi">æ¿æ©‹åŒº</div>
                        <div class="tab-item" data-area="nerima">ç·´é¦¬åŒº</div>
                        <div class="tab-item" data-area="adachi">è¶³ç«‹åŒº</div>
                        <div class="tab-item" data-area="katsushika">è‘›é£¾åŒº</div>
                        <div class="tab-item" data-area="edogawa">æ±Ÿæˆ¸å·åŒº</div>
                    </div>
                </div>

                <!-- å¤šæ‘©åœ°åŸŸ -->
                <div class="tab-group">
                    <div class="tab-group-header" onclick="toggleTabGroup(this)">
                        ğŸŒ² å¤šæ‘©åœ°åŸŸ
                    </div>
                    <div class="tab-items">
                        <div class="tab-item" data-area="hachioji">å…«ç‹å­å¸‚</div>
                        <div class="tab-item" data-area="tachikawa">ç«‹å·å¸‚</div>
                        <div class="tab-item" data-area="musashino">æ­¦è”µé‡å¸‚</div>
                        <div class="tab-item" data-area="mitaka">ä¸‰é·¹å¸‚</div>
                        <div class="tab-item" data-area="machida">ç”ºç”°å¸‚</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸­å¤®ãƒãƒƒãƒ—ã‚¨ãƒªã‚¢ -->
        <div class="map-container">
            <div id="map"></div>
            <div class="map-controls">
                <div class="current-area" id="currentArea">ã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                <div class="area-info" id="areaInfo">å·¦ã®ã‚¿ãƒ–ã‹ã‚‰ã‚¨ãƒªã‚¢ã‚’é¸æŠ</div>
            </div>
        </div>

        <!-- å³ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆãƒãƒ£ãƒƒãƒˆï¼‰ -->
        <div class="right-sidebar collapsed" id="rightSidebar">
            <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()" title="ãƒãƒ£ãƒƒãƒˆã‚’é–‹ã/é–‰ã˜ã‚‹">
                <span class="sidebar-toggle-icon">ğŸ’¬ ãƒãƒ£ãƒƒãƒˆã§è³ªå•</span>
            </button>
            
            <div class="chat-header">
                <div class="chat-title">ğŸ’¬ é§è¼ªå ´ãƒãƒ£ãƒƒãƒˆ</div>
                <div class="chat-subtitle">è³ªå•ã‚„æ¤œç´¢ãŒã§ãã¾ã™</div>
            </div>
            
            <div class="chat-tabs" id="chatTabs">
                <div class="chat-tab active" id="tab-1" onclick="switchChatTab(1)">
                    <span>ğŸ’¬ æ¤œç´¢ãƒãƒ£ãƒƒãƒˆ</span>
                    <button class="tab-close" onclick="event.stopPropagation(); confirmCloseChatTab(1)" title="ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹">Ã—</button>
                </div>
                <div class="new-chat-tab" onclick="createNewChatTab()" title="æ–°ã—ã„ã‚¿ãƒ–ã‚’ä½œæˆ">+</div>
            </div>
            
            <div class="chat-messages" id="chatMessages-1">
                <div class="message bot">
                    <div class="message-content">
                        ã“ã‚“ã«ã¡ã¯ï¼æ±äº¬ã®é§è¼ªå ´ã‚’ãŠæ¢ã—ã§ã™ã­ ğŸš²<br>
                        ã¾ãšã€ã©ã¡ã‚‰ã®æ–¹æ³•ã§æ¢ã—ã¾ã™ã‹ï¼Ÿ
                        <div class="chat-options">
                            <div class="option-button" onclick="selectSearchMethod('destination')">
                                ğŸ“ ç›®çš„åœ°ã‹ã‚‰é§è¼ªå ´ã‚’æ¢ã™
                            </div>
                            <div class="option-button" onclick="selectSearchMethod('area')">
                                ğŸ—ºï¸ ã‚¨ãƒªã‚¢ã‹ã‚‰é§è¼ªå ´ã‚’æ¢ã™
                            </div>
                            <div class="option-button" onclick="selectSearchMethod('condition')">
                                âš™ï¸ æ¡ä»¶ã‹ã‚‰é§è¼ªå ´ã‚’æ¢ã™
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-input">
                <div class="input-container">
                    <input type="text" class="message-input" id="messageInput" placeholder="é§è¼ªå ´ã«ã¤ã„ã¦è³ªå•ã—ã¦ãã ã•ã„...">
                    <button class="send-button" onclick="sendMessage()">é€ä¿¡</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å·¦ä¸‹å›ºå®šåºƒå‘Šã‚¨ãƒªã‚¢ -->
    <div class="bottom-left-ad">
        <div class="ad-close" onclick="closeBottomAd()">&times;</div>
        <div class="ad-content-small">
            <img src="https://via.placeholder.com/200x100/e74c3c/ffffff?text=è‡ªè»¢è»Šä¿é™º" alt="è‡ªè»¢è»Šä¿é™º" class="small-ad-image">
            <div class="small-ad-text">
                <h5>é§è¼ªå ´åˆ©ç”¨è€…å¿…è¦‹ï¼</h5>
                <p>è‡ªè»¢è»Šä¿é™ºã§å®‰å¿ƒãƒ»å®‰å…¨</p>
                <button class="small-ad-button" onclick="handleBottomAdClick()">è©³ç´°</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let map;
        let currentArea = null;
        let markers = [];
        let currentChatTab = 1;
        let chatTabCounter = 1;
        let chatTabs = {
            1: {
                id: 1,
                title: 'ğŸ’¬ æ¤œç´¢ãƒãƒ£ãƒƒãƒˆ',
                messages: [],
                state: {
                    step: 'initial',
                    method: null,
                    destination: null,
                    priority: null,
                    selectedOptions: {}
                }
            }
        };

        // ã‚¨ãƒªã‚¢ãƒ‡ãƒ¼ã‚¿
        const areaData = {
            'shinjuku': { name: 'æ–°å®¿é§…å‘¨è¾º', ward: 'æ–°å®¿åŒº', coordinates: [35.6896, 139.7006] },
            'shibuya': { name: 'æ¸‹è°·é§…å‘¨è¾º', ward: 'æ¸‹è°·åŒº', coordinates: [35.6598, 139.7006] },
            'ikebukuro': { name: 'æ± è¢‹é§…å‘¨è¾º', ward: 'è±Šå³¶åŒº', coordinates: [35.7295, 139.7109] },
            'tokyo': { name: 'æ±äº¬é§…å‘¨è¾º', ward: 'åƒä»£ç”°åŒº', coordinates: [35.6812, 139.7671] },
            'shinagawa': { name: 'å“å·é§…å‘¨è¾º', ward: 'æ¸¯åŒº', coordinates: [35.6284, 139.7387] },
            'ueno': { name: 'ä¸Šé‡é§…å‘¨è¾º', ward: 'å°æ±åŒº', coordinates: [35.7140, 139.7774] },
            'chiyoda': { name: 'åƒä»£ç”°åŒº', ward: 'åƒä»£ç”°åŒº', coordinates: [35.6939, 139.7535] },
            'chuo': { name: 'ä¸­å¤®åŒº', ward: 'ä¸­å¤®åŒº', coordinates: [35.6735, 139.7712] },
            'minato': { name: 'æ¸¯åŒº', ward: 'æ¸¯åŒº', coordinates: [35.6581, 139.7414] },
            'shinjuku_ward': { name: 'æ–°å®¿åŒº', ward: 'æ–°å®¿åŒº', coordinates: [35.6896, 139.7006] },
            'bunkyo': { name: 'æ–‡äº¬åŒº', ward: 'æ–‡äº¬åŒº', coordinates: [35.7083, 139.7516] },
            'taito': { name: 'å°æ±åŒº', ward: 'å°æ±åŒº', coordinates: [35.7120, 139.7795] },
            'sumida': { name: 'å¢¨ç”°åŒº', ward: 'å¢¨ç”°åŒº', coordinates: [35.7100, 139.8017] },
            'koto': { name: 'æ±Ÿæ±åŒº', ward: 'æ±Ÿæ±åŒº', coordinates: [35.6727, 139.8169] },
            'shinagawa_ward': { name: 'å“å·åŒº', ward: 'å“å·åŒº', coordinates: [35.6284, 139.7387] },
            'meguro': { name: 'ç›®é»’åŒº', ward: 'ç›®é»’åŒº', coordinates: [35.6439, 139.7157] },
            'ota': { name: 'å¤§ç”°åŒº', ward: 'å¤§ç”°åŒº', coordinates: [35.5613, 139.7164] },
            'setagaya': { name: 'ä¸–ç”°è°·åŒº', ward: 'ä¸–ç”°è°·åŒº', coordinates: [35.6464, 139.6534] },
            'shibuya_ward': { name: 'æ¸‹è°·åŒº', ward: 'æ¸‹è°·åŒº', coordinates: [35.6598, 139.7006] },
            'nakano': { name: 'ä¸­é‡åŒº', ward: 'ä¸­é‡åŒº', coordinates: [35.7055, 139.6653] },
            'suginami': { name: 'æ‰ä¸¦åŒº', ward: 'æ‰ä¸¦åŒº', coordinates: [35.6998, 139.6363] },
            'toshima': { name: 'è±Šå³¶åŒº', ward: 'è±Šå³¶åŒº', coordinates: [35.7295, 139.7109] },
            'kita': { name: 'åŒ—åŒº', ward: 'åŒ—åŒº', coordinates: [35.7539, 139.7340] },
            'arakawa': { name: 'è’å·åŒº', ward: 'è’å·åŒº', coordinates: [35.7364, 139.7834] },
            'itabashi': { name: 'æ¿æ©‹åŒº', ward: 'æ¿æ©‹åŒº', coordinates: [35.7505, 139.7089] },
            'nerima': { name: 'ç·´é¦¬åŒº', ward: 'ç·´é¦¬åŒº', coordinates: [35.7353, 139.6532] },
            'adachi': { name: 'è¶³ç«‹åŒº', ward: 'è¶³ç«‹åŒº', coordinates: [35.7751, 139.8048] },
            'katsushika': { name: 'è‘›é£¾åŒº', ward: 'è‘›é£¾åŒº', coordinates: [35.7436, 139.8485] },
            'edogawa': { name: 'æ±Ÿæˆ¸å·åŒº', ward: 'æ±Ÿæˆ¸å·åŒº', coordinates: [35.7069, 139.8683] },
            'hachioji': { name: 'å…«ç‹å­å¸‚', ward: 'å…«ç‹å­å¸‚', coordinates: [35.6560, 139.3439] },
            'tachikawa': { name: 'ç«‹å·å¸‚', ward: 'ç«‹å·å¸‚', coordinates: [35.7022, 139.4138] },
            'musashino': { name: 'æ­¦è”µé‡å¸‚', ward: 'æ­¦è”µé‡å¸‚', coordinates: [35.7178, 139.5640] },
            'mitaka': { name: 'ä¸‰é·¹å¸‚', ward: 'ä¸‰é·¹å¸‚', coordinates: [35.6837, 139.5596] },
            'machida': { name: 'ç”ºç”°å¸‚', ward: 'ç”ºç”°å¸‚', coordinates: [35.5439, 139.4269] }
        };

        // ã‚µã‚¤ãƒ‰ãƒãƒ¼è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function toggleSidebar() {
            const sidebar = document.getElementById('rightSidebar');
            const toggle = document.getElementById('sidebarToggle');
            const mainContainer = document.querySelector('.main-container');
            
            if (sidebar.classList.contains('collapsed')) {
                sidebar.classList.remove('collapsed');
                mainContainer.classList.remove('chat-collapsed');
                toggle.innerHTML = '<span class="sidebar-toggle-icon">â—€</span>';
            } else {
                sidebar.classList.add('collapsed');
                mainContainer.classList.add('chat-collapsed');
                toggle.innerHTML = '<span class="sidebar-toggle-icon">ğŸ’¬ ãƒãƒ£ãƒƒãƒˆã§è³ªå•</span>';
            }
        }

        // æ–°ã—ã„ã‚¿ãƒ–ä½œæˆ
        function createNewChatTab() {
            chatTabCounter++;
            const newTabId = chatTabCounter;
            
            // æ–°ã—ã„ã‚¿ãƒ–ãƒ‡ãƒ¼ã‚¿
            chatTabs[newTabId] = {
                id: newTabId,
                title: `ğŸ’¬ è³ªå• ${newTabId}`,
                messages: [],
                state: {
                    step: 'initial',
                    method: null,
                    destination: null,
                    priority: null,
                    selectedOptions: {}
                }
            };
            
            // ã‚¿ãƒ–UIã‚’è¿½åŠ 
            const tabsContainer = document.getElementById('chatTabs');
            const newChatTab = tabsContainer.querySelector('.new-chat-tab');
            
            const tabElement = document.createElement('div');
            tabElement.className = 'chat-tab';
            tabElement.id = `tab-${newTabId}`;
            tabElement.onclick = () => switchChatTab(newTabId);
            tabElement.innerHTML = `
                <span>${chatTabs[newTabId].title}</span>
                <button class="tab-close" onclick="event.stopPropagation(); confirmCloseChatTab(${newTabId})" title="ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹">Ã—</button>
            `;
            
            tabsContainer.insertBefore(tabElement, newChatTab);
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ã‚’ä½œæˆ
            const chatContainer = document.querySelector('.right-sidebar');
            const messagesContainer = document.createElement('div');
            messagesContainer.className = 'chat-messages';
            messagesContainer.id = `chatMessages-${newTabId}`;
            messagesContainer.style.display = 'none';
            messagesContainer.innerHTML = `
                <div class="message bot">
                    <div class="message-content">
                        ã“ã‚“ã«ã¡ã¯ï¼æ±äº¬ã®é§è¼ªå ´ã‚’ãŠæ¢ã—ã§ã™ã­ ğŸš²<br>
                        ã¾ãšã€ã©ã¡ã‚‰ã®æ–¹æ³•ã§æ¢ã—ã¾ã™ã‹ï¼Ÿ
                        <div class="chat-options">
                            <div class="option-button" onclick="selectSearchMethod('destination')">
                                ğŸ“ ç›®çš„åœ°ã‹ã‚‰é§è¼ªå ´ã‚’æ¢ã™
                            </div>
                            <div class="option-button" onclick="selectSearchMethod('area')">
                                ğŸ—ºï¸ ã‚¨ãƒªã‚¢ã‹ã‚‰é§è¼ªå ´ã‚’æ¢ã™
                            </div>
                            <div class="option-button" onclick="selectSearchMethod('condition')">
                                âš™ï¸ æ¡ä»¶ã‹ã‚‰é§è¼ªå ´ã‚’æ¢ã™
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const chatInput = chatContainer.querySelector('.chat-input');
            chatContainer.insertBefore(messagesContainer, chatInput);
            
            // æ–°ã—ã„ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
            switchChatTab(newTabId);
            
            // æˆåŠŸé€šçŸ¥
            showNotification(`æ–°ã—ã„ã‚¿ãƒ–ã€Œ${chatTabs[newTabId].title}ã€ã‚’ä½œæˆã—ã¾ã—ãŸ`, 'success');
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchChatTab(tabId) {
            // å‰ã®ã‚¿ãƒ–ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            document.querySelectorAll('.chat-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.chat-messages').forEach(messages => {
                messages.style.display = 'none';
            });
            
            // æ–°ã—ã„ã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.getElementById(`chatMessages-${tabId}`).style.display = 'block';
            
            currentChatTab = tabId;
        }

        // ã‚¿ãƒ–å‰Šé™¤ç¢ºèª
        function confirmCloseChatTab(tabId) {
            const tabCount = Object.keys(chatTabs).length;
            
            if (tabCount <= 1) {
                showNotification('æœ€ä½1ã¤ã®ã‚¿ãƒ–ã¯å¿…è¦ã§ã™', 'warning');
                return;
            }
            
            closeChatTab(tabId);
        }

        // ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
        function closeChatTab(tabId) {
            const tabElement = document.getElementById(`tab-${tabId}`);
            const messagesElement = document.getElementById(`chatMessages-${tabId}`);
            
            // å‰Šé™¤ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
            tabElement.classList.add('tab-removing');
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«å‰Šé™¤
            setTimeout(() => {
                // ã‚¿ãƒ–ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
                delete chatTabs[tabId];
                
                // UIå‰Šé™¤
                tabElement.remove();
                messagesElement.remove();
                
                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ãŒå‰Šé™¤ã•ã‚ŒãŸå ´åˆã€ä»–ã®ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
                if (currentChatTab === tabId) {
                    const remainingTabIds = Object.keys(chatTabs).map(id => parseInt(id));
                    const remainingTabId = remainingTabIds[0];
                    switchChatTab(remainingTabId);
                }
                
                showNotification('ã‚¿ãƒ–ã‚’é–‰ã˜ã¾ã—ãŸ', 'success');
            }, 300);
        }

        // é€šçŸ¥è¡¨ç¤º
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const colors = {
                success: '#27ae60',
                warning: '#f39c12',
                error: '#e74c3c',
                info: '#3498db'
            };
            
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${colors[type]};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                animation: slideInRight 0.3s ease-out;
            `;
            notification.textContent = message;
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³CSSè¿½åŠ 
            if (!document.getElementById('notification-animations')) {
                const style = document.createElement('style');
                style.id = 'notification-animations';
                style.textContent = `
                    @keyframes slideInRight {
                        from {
                            opacity: 0;
                            transform: translateX(100px);
                        }
                        to {
                            opacity: 1;
                            transform: translateX(0);
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(notification);
            
            // 3ç§’å¾Œã«å‰Šé™¤
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // åœ°å›³åˆæœŸåŒ–
        function initMap() {
            map = L.map('map').setView([35.6762, 139.6503], 11);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
        }

        // ã‚¿ãƒ–ã‚°ãƒ«ãƒ¼ãƒ—ã®é–‹é–‰
        function toggleTabGroup(header) {
            const tabItems = header.nextElementSibling;
            const isActive = tabItems.classList.contains('active');
            
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹
            document.querySelectorAll('.tab-items').forEach(items => {
                items.classList.remove('active');
            });
            
            // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¿ãƒ–ã‚’é–‹ãï¼ˆã™ã§ã«é–‹ã„ã¦ã„ãŸå ´åˆã¯é–‰ã˜ã‚‹ï¼‰
            if (!isActive) {
                tabItems.classList.add('active');
            }
        }

        // ã‚¨ãƒªã‚¢é¸æŠ
        function selectArea(areaId) {
            console.log('ã‚¨ãƒªã‚¢é¸æŠ:', areaId);
            
            if (!areaData[areaId]) {
                console.error('ç„¡åŠ¹ãªã‚¨ãƒªã‚¢:', areaId);
                return;
            }

            const area = areaData[areaId];
            currentArea = areaId;

            // å‰ã®é¸æŠã‚’è§£é™¤
            document.querySelectorAll('.tab-item').forEach(item => {
                item.classList.remove('selected');
            });

            // æ–°ã—ã„é¸æŠã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            document.querySelector(`[data-area="${areaId}"]`).classList.add('selected');

            // ãƒãƒƒãƒ—ç§»å‹•
            if (map) {
                map.setView(area.coordinates, 15);
            }

            // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«æ›´æ–°
            document.getElementById('currentArea').textContent = area.name;
            document.getElementById('areaInfo').textContent = `${area.ward} ã‚’è¡¨ç¤ºä¸­`;

            // é§è¼ªå ´ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆãƒ¢ãƒƒã‚¯ï¼‰
            generateMockParkingData(area);

            // ãƒãƒ£ãƒƒãƒˆã«çµæœè¡¨ç¤ºï¼ˆã‚¨ãƒªã‚¢é¸æŠæ™‚ã¯å±¥æ­´ã«æ®‹ã•ãªã„ï¼‰
            const currentState = chatTabs[currentChatTab].state;
            if (currentState.method === 'area') {
                // ã‚¨ãƒªã‚¢é¸æŠãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯å±¥æ­´ã«æ®‹ã•ãšã€ãƒãƒƒãƒ—æƒ…å ±ã®ã¿æ›´æ–°
                currentState.method = null; // ãƒªã‚»ãƒƒãƒˆ
            } else if (currentState.method === 'destination') {
                // ç›®çš„åœ°æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ - ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«è¿½åŠ 
                addBotMessage(`${area.name}å‘¨è¾ºã®é§è¼ªå ´ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ ğŸ“`, generateMockParkingList(area));
            } else {
                // ç›´æ¥ã‚¿ãƒ–ã‚¯ãƒªãƒƒã‚¯ - é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ï¼ˆè©³ç´°ãªå±¥æ­´ã¯ä¸è¦ï¼‰
                showMapNotification(`${area.name}ã®é§è¼ªå ´æƒ…å ±ã‚’è¡¨ç¤ºä¸­`);
            }
        }

        // ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½œæˆ
        function createCustomIcon(available) {
            let color, textColor;
            
            if (available <= 5) {
                color = '#e74c3c'; // èµ¤
                textColor = 'white';
            } else if (available <= 15) {
                color = '#f39c12'; // é»„è‰²
                textColor = 'white';
            } else {
                color = '#27ae60'; // ç·‘
                textColor = 'white';
            }
            
            return L.divIcon({
                className: 'custom-div-icon',
                html: `
                    <div style="
                        background-color: ${color};
                        width: 30px;
                        height: 30px;
                        border-radius: 50% 50% 50% 0;
                        border: 2px solid white;
                        transform: rotate(-45deg);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                    ">
                        <span style="
                            color: ${textColor};
                            font-size: 10px;
                            font-weight: bold;
                            transform: rotate(45deg);
                        ">${available}</span>
                    </div>
                `,
                iconSize: [30, 30],
                iconAnchor: [15, 30]
            });
        }

        // ãƒ¢ãƒƒã‚¯é§è¼ªå ´ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
        function generateMockParkingData(area) {
            // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            const parkingNames = ['é§…å‰é§è¼ªå ´', 'å¸‚å–¶é§è¼ªå ´', 'å•†æ¥­æ–½è¨­é§è¼ªå ´', 'å…¬åœ’é§è¼ªå ´', 'ç—…é™¢é§è¼ªå ´'];
            
            for (let i = 0; i < 5; i++) {
                const lat = area.coordinates[0] + (Math.random() - 0.5) * 0.01;
                const lng = area.coordinates[1] + (Math.random() - 0.5) * 0.01;
                const available = Math.floor(Math.random() * 50) + 1; // 1-50ã®ç©ºãå°æ•°
                const total = Math.floor(Math.random() * 20) + 80;
                const fee = (Math.floor(Math.random() * 5) + 1) * 100;
                
                const customIcon = createCustomIcon(available);
                
                const marker = L.marker([lat, lng], { icon: customIcon }).addTo(map)
                    .bindPopup(`
                        <div>
                            <h4>${area.ward}${parkingNames[i]}</h4>
                            <p style="color: ${available <= 5 ? '#e74c3c' : available <= 15 ? '#f39c12' : '#27ae60'}; font-weight: bold;">
                                ç©ºã: ${available}/${total}å°
                            </p>
                            <p>æ–™é‡‘: ${fee}å††/æ—¥</p>
                            <p>å–¶æ¥­: 24æ™‚é–“</p>
                        </div>
                    `);
                
                markers.push(marker);
            }
        }

        // ãƒ¢ãƒƒã‚¯é§è¼ªå ´ãƒªã‚¹ãƒˆç”Ÿæˆ
        function generateMockParkingList(area) {
            const parkingNames = ['é§…å‰é§è¼ªå ´', 'å¸‚å–¶é§è¼ªå ´', 'å•†æ¥­æ–½è¨­é§è¼ªå ´', 'å…¬åœ’é§è¼ªå ´', 'ç—…é™¢é§è¼ªå ´'];
            let html = '<div class="parking-list">';
            
            for (let i = 0; i < 5; i++) {
                const available = Math.floor(Math.random() * 50) + 10;
                const total = Math.floor(Math.random() * 20) + 80;
                const fee = (Math.floor(Math.random() * 5) + 1) * 100;
                
                html += `
                    <div class="parking-card">
                        <div class="parking-name">${area.ward}${parkingNames[i]}</div>
                        <div class="parking-info">
                            <span>ç©ºã: ${available}/${total}å°</span>
                            <span>${fee}å††/æ—¥</span>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        // ãƒãƒƒãƒ—é€šçŸ¥è¡¨ç¤º
        function showMapNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: absolute;
                top: 80px;
                right: 20px;
                background: #27ae60;
                color: white;
                padding: 10px 15px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 1000;
                animation: fadeInOut 3s ease-in-out;
            `;
            notification.textContent = message;
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®CSSã‚’è¿½åŠ 
            if (!document.getElementById('notification-style')) {
                const style = document.createElement('style');
                style.id = 'notification-style';
                style.textContent = `
                    @keyframes fadeInOut {
                        0% { opacity: 0; transform: translateY(-10px); }
                        20%, 80% { opacity: 1; transform: translateY(0); }
                        100% { opacity: 0; transform: translateY(-10px); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.querySelector('.map-container').appendChild(notification);
            
            // 3ç§’å¾Œã«å‰Šé™¤
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ãƒãƒ£ãƒƒãƒˆçŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
        function resetChatState() {
            chatTabs[currentChatTab].state = {
                step: 'initial',
                method: null,
                destination: null,
                priority: null,
                selectedOptions: {}
            };
        }

        // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
        function addBotMessage(text, html = '') {
            const chatMessages = document.getElementById(`chatMessages-${currentChatTab}`);
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            messageDiv.innerHTML = `
                <div class="message-content">
                    ${text}
                    ${html}
                    ${html ? '<div style="margin-top: 10px;"><button class="confirm-button" onclick="showNewSearchOptions()">åˆ¥ã®æ¤œç´¢ã‚’ã™ã‚‹</button></div>' : ''}
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // æ–°ã—ã„æ¤œç´¢ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
        function showNewSearchOptions() {
            resetChatState();
            const html = `
                ä»–ã®é§è¼ªå ´ã‚‚æ¢ã—ã¦ã¿ã¾ã™ã‹ï¼Ÿ ğŸ”
                <div class="chat-options">
                    <div class="option-button" onclick="selectSearchMethod('destination')">
                        ğŸ“ ç›®çš„åœ°ã‹ã‚‰é§è¼ªå ´ã‚’æ¢ã™
                    </div>
                    <div class="option-button" onclick="selectSearchMethod('area')">
                        ğŸ—ºï¸ ã‚¨ãƒªã‚¢ã‹ã‚‰é§è¼ªå ´ã‚’æ¢ã™
                    </div>
                    <div class="option-button" onclick="selectSearchMethod('condition')">
                        âš™ï¸ æ¡ä»¶ã‹ã‚‰é§è¼ªå ´ã‚’æ¢ã™
                    </div>
                </div>
            `;
            addBotMessage(html);
        }

        function addUserMessage(text) {
            const chatMessages = document.getElementById(`chatMessages-${currentChatTab}`);
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.innerHTML = `
                <div class="message-content">${text}</div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // æ¤œç´¢æ–¹æ³•é¸æŠ
        function selectSearchMethod(method) {
            const currentState = chatTabs[currentChatTab].state;
            currentState.method = method;
            currentState.step = 'method_selected';
            
            // é¸æŠã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            document.querySelectorAll('.option-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            setTimeout(() => {
                if (method === 'destination') {
                    showDestinationInput();
                } else if (method === 'area') {
                    showAreaSelectionMessage();
                } else if (method === 'condition') {
                    showConditionOptions();
                }
            }, 500);
        }

        // ç›®çš„åœ°å…¥åŠ›ã‚’è¡¨ç¤º
        function showDestinationInput() {
            const html = `
                ç›®çš„åœ°ã‚’æ•™ãˆã¦ãã ã•ã„ ğŸ“<br>
                é§…åã€æ–½è¨­åã€ä½æ‰€ãªã©ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
                <input type="text" class="destination-input" id="destinationInput" placeholder="ä¾‹ï¼šæ–°å®¿é§…ã€æ±äº¬ã‚¹ã‚«ã‚¤ãƒ„ãƒªãƒ¼ã€æ¸‹è°·109">
                <button class="confirm-button" onclick="confirmDestination()">ã“ã®ç›®çš„åœ°ã§æ¤œç´¢</button>
            `;
            addBotMessage(html);
        }

        // ã‚¨ãƒªã‚¢é¸æŠãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        function showAreaSelectionMessage() {
            chatTabs[currentChatTab].state.method = 'area';
            addBotMessage('å·¦ã®ã‚¨ãƒªã‚¢ã‚¿ãƒ–ã‹ã‚‰åœ°åŸŸã‚’é¸æŠã—ã¦ãã ã•ã„ ğŸ—ºï¸<br>é¸æŠã™ã‚‹ã¨ã€ãã®åœ°åŸŸã®é§è¼ªå ´ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚');
        }

        // æ¡ä»¶é¸æŠã‚’è¡¨ç¤º
        function showConditionOptions() {
            const html = `
                ã©ã®ã‚ˆã†ãªæ¡ä»¶ã§ãŠæ¢ã—ã§ã™ã‹ï¼Ÿ âš™ï¸
                <div class="chat-options">
                    <div class="option-button" onclick="selectCondition('price')">
                        ğŸ’° æ–™é‡‘ãŒå®‰ã„é§è¼ªå ´
                    </div>
                    <div class="option-button" onclick="selectCondition('availability')">
                        ğŸš² ç©ºããŒå¤šã„é§è¼ªå ´
                    </div>
                    <div class="option-button" onclick="selectCondition('24hours')">
                        ğŸŒ™ 24æ™‚é–“å–¶æ¥­ã®é§è¼ªå ´
                    </div>
                    <div class="option-button" onclick="selectCondition('station')">
                        ğŸš‰ é§…ã‹ã‚‰è¿‘ã„é§è¼ªå ´
                    </div>
                </div>
            `;
            addBotMessage(html);
        }

        // ç›®çš„åœ°ç¢ºå®š
        function confirmDestination() {
            const input = document.getElementById('destinationInput');
            const destination = input.value.trim();
            
            if (!destination) {
                alert('ç›®çš„åœ°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            chatTabs[currentChatTab].state.destination = destination;
            addUserMessage(destination);
            
            // ç›®çš„åœ°ã‹ã‚‰æœ€é©ãªã‚¨ãƒªã‚¢ã‚’æ¨å®š
            const estimatedArea = estimateAreaFromDestination(destination);
            if (estimatedArea) {
                selectArea(estimatedArea);
            }
            
            // å„ªå…ˆé †ä½ã‚’èã
            setTimeout(() => {
                showPriorityOptions(destination);
            }, 1000);
        }

        // ç›®çš„åœ°ã‹ã‚‰ã‚¨ãƒªã‚¢ã‚’æ¨å®š
        function estimateAreaFromDestination(destination) {
            const dest = destination.toLowerCase();
            
            if (dest.includes('æ–°å®¿') || dest.includes('shinjuku')) return 'shinjuku';
            if (dest.includes('æ¸‹è°·') || dest.includes('shibuya')) return 'shibuya';
            if (dest.includes('æ± è¢‹') || dest.includes('ikebukuro')) return 'ikebukuro';
            if (dest.includes('æ±äº¬é§…') || dest.includes('tokyo')) return 'tokyo';
            if (dest.includes('å“å·') || dest.includes('shinagawa')) return 'shinagawa';
            if (dest.includes('ä¸Šé‡') || dest.includes('ueno')) return 'ueno';
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ± è¢‹
            return 'ikebukuro';
        }

        // å„ªå…ˆé †ä½é¸æŠã‚’è¡¨ç¤º
        function showPriorityOptions(destination) {
            const html = `
                ã€Œ${destination}ã€å‘¨è¾ºã®é§è¼ªå ´ã§ã™ã­ï¼<br>
                ä½•ã‚’é‡è¦–ã—ã¦é¸ã³ã¾ã™ã‹ï¼Ÿ ğŸ¤”
                <div class="chat-options">
                    <div class="option-button" onclick="selectPriority('distance')">
                        ğŸš¶ ç›®çš„åœ°ã‹ã‚‰ã®è·é›¢
                    </div>
                    <div class="option-button" onclick="selectPriority('price')">
                        ğŸ’° æ–™é‡‘ã®å®‰ã•
                    </div>
                    <div class="option-button" onclick="selectPriority('availability')">
                        ğŸš² ç©ºãã®å¤šã•
                    </div>
                    <div class="option-button" onclick="selectPriority('hours')">
                        ğŸ• å–¶æ¥­æ™‚é–“ã®é•·ã•
                    </div>
                </div>
            `;
            addBotMessage(html);
        }

        // å„ªå…ˆé †ä½é¸æŠ
        function selectPriority(priority) {
            chatTabs[currentChatTab].state.priority = priority;
            
            // é¸æŠã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            document.querySelectorAll('.option-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            const priorityNames = {
                'distance': 'è·é›¢é‡è¦–',
                'price': 'æ–™é‡‘é‡è¦–',
                'availability': 'ç©ºãçŠ¶æ³é‡è¦–',
                'hours': 'å–¶æ¥­æ™‚é–“é‡è¦–'
            };
            
            setTimeout(() => {
                const resultHtml = generatePrioritizedParkingList(chatTabs[currentChatTab].state.destination, priority);
                addBotMessage(`${priorityNames[priority]}ã§æ¤œç´¢ã—ã¾ã—ãŸï¼ ğŸ¯`, resultHtml);
            }, 800);
        }

        // æ¡ä»¶é¸æŠ
        function selectCondition(condition) {
            chatTabs[currentChatTab].state.priority = condition;
            
            // é¸æŠã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            document.querySelectorAll('.option-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            setTimeout(() => {
                const resultHtml = generateConditionBasedParkingList(condition);
                addBotMessage(`æ¡ä»¶ã«åˆã†é§è¼ªå ´ã‚’è¦‹ã¤ã‘ã¾ã—ãŸï¼ âœ¨`, resultHtml);
            }, 800);
        }

        // å„ªå…ˆé †ä½ã«åŸºã¥ãé§è¼ªå ´ãƒªã‚¹ãƒˆç”Ÿæˆ
        function generatePrioritizedParkingList(destination, priority) {
            const parkingData = [
                { name: `${destination}é§…å‰é§è¼ªå ´`, distance: 'å¾’æ­©1åˆ†', price: 200, availability: 45, hours: '24æ™‚é–“' },
                { name: `${destination}å¸‚å–¶é§è¼ªå ´`, distance: 'å¾’æ­©3åˆ†', price: 100, availability: 23, hours: '6:00-22:00' },
                { name: `${destination}å•†æ¥­æ–½è¨­é§è¼ªå ´`, distance: 'å¾’æ­©5åˆ†', price: 300, availability: 67, hours: '24æ™‚é–“' },
                { name: `${destination}å…¬åœ’é§è¼ªå ´`, distance: 'å¾’æ­©7åˆ†', price: 150, availability: 89, hours: '5:00-23:00' }
            ];

            // å„ªå…ˆé †ä½ã«åŸºã¥ã„ã¦ã‚½ãƒ¼ãƒˆ
            if (priority === 'distance') {
                parkingData.sort((a, b) => parseInt(a.distance) - parseInt(b.distance));
            } else if (priority === 'price') {
                parkingData.sort((a, b) => a.price - b.price);
            } else if (priority === 'availability') {
                parkingData.sort((a, b) => b.availability - a.availability);
            }

            let html = '<div class="parking-list">';
            parkingData.forEach((parking, index) => {
                const tag = index === 0 ? `<span class="priority-tag ${priority}">ãŠã™ã™ã‚</span>` : '';
                html += `
                    <div class="parking-card">
                        <div class="parking-name">${parking.name}${tag}</div>
                        <div class="parking-info">
                            <span>${parking.distance} | ç©ºã: ${parking.availability}å°</span>
                            <span>${parking.price}å††/æ—¥</span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        // æ¡ä»¶ã«åŸºã¥ãé§è¼ªå ´ãƒªã‚¹ãƒˆç”Ÿæˆ
        function generateConditionBasedParkingList(condition) {
            let html = '<div class="parking-list">';
            
            if (condition === 'price') {
                const cheapParkings = [
                    { name: 'å¸‚å–¶ç¬¬ä¸€é§è¼ªå ´', price: 50, info: 'å¾’æ­©5åˆ†' },
                    { name: 'åŒºå–¶é§è¼ªå ´', price: 80, info: 'å¾’æ­©3åˆ†' },
                    { name: 'å•†åº—è¡—é§è¼ªå ´', price: 100, info: 'å¾’æ­©2åˆ†' }
                ];
                cheapParkings.forEach(parking => {
                    html += `
                        <div class="parking-card">
                            <div class="parking-name">${parking.name}<span class="priority-tag price">æ¿€å®‰</span></div>
                            <div class="parking-info">
                                <span>${parking.info}</span>
                                <span>${parking.price}å††/æ—¥</span>
                            </div>
                        </div>
                    `;
                });
            } else if (condition === '24hours') {
                const allDayParkings = [
                    { name: '24æ™‚é–“é§…å‰é§è¼ªå ´', info: 'å¾’æ­©1åˆ† | ç©ºã: 34å°' },
                    { name: 'ã‚³ãƒ³ãƒ“ãƒ‹ä½µè¨­é§è¼ªå ´', info: 'å¾’æ­©4åˆ† | ç©ºã: 12å°' },
                    { name: '24æ™‚é–“å•†æ¥­æ–½è¨­é§è¼ªå ´', info: 'å¾’æ­©6åˆ† | ç©ºã: 56å°' }
                ];
                allDayParkings.forEach(parking => {
                    html += `
                        <div class="parking-card">
                            <div class="parking-name">${parking.name}<span class="priority-tag">24H</span></div>
                            <div class="parking-info">
                                <span>${parking.info}</span>
                                <span>200å††/æ—¥</span>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            return html;
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ï¼ˆãƒ•ãƒªãƒ¼å…¥åŠ›ï¼‰
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addUserMessage(message);
            input.value = '';
            
            // ç°¡å˜ãªå¿œç­”ãƒ­ã‚¸ãƒƒã‚¯
            setTimeout(() => {
                if (message.includes('ç©ºã') || message.includes('available')) {
                    showConditionOptions();
                } else if (message.includes('æ–™é‡‘') || message.includes('å®‰ã„')) {
                    selectCondition('price');
                } else if (message.includes('24æ™‚é–“') || message.includes('æ·±å¤œ')) {
                    selectCondition('24hours');
                } else {
                    addBotMessage('ã”è³ªå•ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ä¸Šã®é¸æŠè‚¢ã‹ã‚‰æ¤œç´¢æ–¹æ³•ã‚’é¸ã‚“ã§ã„ãŸã ãã‹ã€å…·ä½“çš„ãªç›®çš„åœ°ã‚„æ¡ä»¶ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚');
                }
            }, 500);
        }

        // å·¦ä¸‹åºƒå‘Šé–¢é€£ã®é–¢æ•°
        function closeBottomAd() {
            const ad = document.querySelector('.bottom-left-ad');
            ad.style.animation = 'slideOutLeft 0.3s ease-in';
            setTimeout(() => {
                ad.style.display = 'none';
            }, 300);
        }

        function handleBottomAdClick() {
            console.log('å·¦ä¸‹åºƒå‘Šã‚¯ãƒªãƒƒã‚¯ - ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯ã¸é·ç§»');
            // window.open('https://affiliate-link.com', '_blank');
        }

        // slideOutLeft ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
        const adStyle = document.createElement('style');
        adStyle.textContent = `
            @keyframes slideOutLeft {
                from {
                    opacity: 1;
                    transform: translateX(0);
                }
                to {
                    opacity: 0;
                    transform: translateX(-100px);
                }
            }
        `;
        document.head.appendChild(adStyle);

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        document.addEventListener('DOMContentLoaded', function() {
            // åœ°å›³åˆæœŸåŒ–
            initMap();
            
            // ã‚¿ãƒ–ã‚¢ã‚¤ãƒ†ãƒ ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            document.querySelectorAll('.tab-item').forEach(item => {
                item.addEventListener('click', function() {
                    const areaId = this.getAttribute('data-area');
                    selectArea(areaId);
                });
            });
            
            // Enterã‚­ãƒ¼ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
        });
    </script>
</body>
</html>