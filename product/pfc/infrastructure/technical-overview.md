# PFC システム技術構成概要

## 🏗️ アーキテクチャサマリー

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   👤 ユーザー    │    │  🌐 フロント層   │    │   ⚡ API層      │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│ • Webブラウザ    │───▶│ • React SPA     │───▶│ • API Gateway   │
│ • モバイル      │    │ • CloudFront    │    │ • Lambda x3     │
│ • タブレット    │    │ • S3 Static     │    │ • CORS設定     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                        │
                       ┌─────────────────┐    ┌─────────────────┐
                       │  🤖 AI/ML層     │    │  🗄️ データ層    │
                       ├─────────────────┤    ├─────────────────┤
                       │ • Bedrock       │◀───│ • DynamoDB      │
                       │ • Claude-3-Haiku│    │ • 駐車場データ   │
                       │ • コスト最適化   │    │ • リアルタイム   │
                       └─────────────────┘    └─────────────────┘
```

## 🎯 選択肢型チャットフロー

```
STEP 1: 場所選択
┌──────────────────────────────────────┐
│  🌳 公園  🚉 駅周辺  🛒 商業施設  🏥 病院  │ ⇐ ユーザー選択
└──────────────────────────────────────┘
                    ↓ (ローカル処理)

STEP 2: 優先条件
┌──────────────────────────────────────┐
│  💰 無料  💸 安い  🚶 駅近  🏍️ バイク可  │ ⇐ ユーザー選択  
└──────────────────────────────────────┘
                    ↓ (ローカル処理)

STEP 3: エリア選択
┌──────────────────────────────────────┐
│  西口周辺  東口周辺  駅周辺  📍 現在地   │ ⇐ ユーザー選択
└──────────────────────────────────────┘
                    ↓ (API呼び出し)

BACKEND: フィルタリング + AI処理
┌──────────────────────────────────────┐
│ 1. DynamoDB事前フィルタ (最大10件)     │
│ 2. 超短縮プロンプト生成 (150トークン)   │  
│ 3. Claude-3-Haiku処理              │
│ 4. 推奨3件 + サジェスト生成          │
└──────────────────────────────────────┘
                    ↓

RESULT: 結果表示
┌──────────────────────────────────────┐
│ • 推奨駐車場 3件表示                  │
│ • マップにマーカー更新               │
│ • サジェスト表示                    │
│ • 📱 モバイル最適化UI                │
└──────────────────────────────────────┘
```

## 📊 コスト比較

### 従来方式 vs 選択肢型
```
従来方式 (月1000アクセス)
├─ Bedrock (Sonnet)      $10.80  ██████████████████████ 81%
├─ Lambda実行           $1.21   ███ 9%
├─ DynamoDB             $0.67   ██ 5%  
├─ その他              $0.68   ██ 5%
└─ 合計                $13.36  ████████████████████████ 100%

選択肢型最適化 (月1000アクセス)  
├─ Bedrock (Haiku)      $1.20   ████████ 32%
├─ Lambda実行           $1.21   ████████ 32%
├─ DynamoDB             $0.67   █████ 18%
├─ その他              $0.68   █████ 18%
└─ 合計                $3.76   ████████████████ 100%

削減効果: $9.60削減 (72%改善) 💰
```

## 🛠️ 技術スタック

### フロントエンド
- **React 18**: 選択肢型UI + フリー入力モード
- **Leaflet**: インタラクティブマップ
- **CSS Grid**: レスポンシブレイアウト
- **CloudFront**: グローバルCDN配信

### バックエンド
- **AWS Lambda**: サーバーレス実行環境
- **Python 3.13**: ランタイム
- **API Gateway**: RESTful API
- **DynamoDB**: NoSQLデータベース

### AI/ML
- **Amazon Bedrock**: 生成AIサービス
- **Claude-3-Haiku**: 高速・低コストモデル
- **プロンプト最適化**: トークン数最小化

### インフラ
- **Terraform**: IaC管理
- **EventBridge**: スケジューラー
- **CloudWatch**: 監視・ログ
- **S3**: 静的ホスティング

## 🔧 最適化技術

### 1. Bedrockコスト削減
```python
# 従来のプロンプト (1000トークン)
prompt = f"""
あなたは池袋エリアの駐車場案内アシスタントです。
ユーザーの質問: {user_input}
利用可能な駐車場データ: {all_parking_data}
詳細な説明と理由も含めて回答してください。
"""

# 最適化プロンプト (150トークン) 
prompt = f"{priority}重視で{area}の駐車場。{count}件:{data}。上位3つ推奨理由各1行"
```

### 2. DynamoDB事前フィルタリング
```python
# 選択情報からフィルタ構築
filters = {
    'fee_max': 300,           # 安い重視
    'distance_max': 200,      # 駅近重視  
    'bike_types': '原付',     # バイク可
    'area': 'ikebukuro_west'  # 西口エリア
}

# 事前絞り込み (50件→10件)
filtered_data = dynamodb.scan(
    FilterExpression=build_filter(filters),
    Limit=10
)
```

### 3. フロントエンド最適化
```javascript
// 選択肢はローカル処理 (API呼び出し不要)
const handleSelection = (option) => {
  if (currentStep < 3) {
    // ローカルでステップ進行
    setCurrentStep(currentStep + 1);
  } else {
    // 最終段階のみAPI呼び出し
    callAPI(selections);
  }
};
```

## 📈 パフォーマンス指標

### レスポンス時間
- **選択肢表示**: < 100ms (ローカル処理)
- **API応答**: < 2000ms (Bedrock最適化)
- **マップ更新**: < 500ms (事前フィルタ)

### スループット
- **同時接続**: 1000接続/秒
- **API処理**: 500req/秒
- **データ取得**: 10分間隔更新

### 可用性
- **Lambda**: 99.95%
- **DynamoDB**: 99.99%
- **CloudFront**: 99.9%

## 🔒 セキュリティ

### 認証・認可
- **IAM**: 最小権限原則
- **Lambda実行ロール**: 必要リソースのみ
- **Bedrock権限**: 特定モデル限定

### データ保護
- **DynamoDB**: 保存時暗号化
- **API Gateway**: HTTPS強制
- **CloudFront**: 地域制限 (JP/US)

### 監視・アラート
- **CloudWatch**: メトリクス監視
- **コスト上限**: $50/月でアラート
- **エラー率**: 5%超過でアラート

## 🚀 運用・保守

### デプロイメント
```bash
# Terraform でインフラ管理
terraform plan
terraform apply

# Lambda関数デプロイ
zip -r function.zip .
aws lambda update-function-code
```

### 監視ダッシュボード
- **Lambda実行回数・エラー率**
- **Bedrock使用量・コスト**
- **DynamoDBスループット**
- **ユーザーアクセス数**

### スケーリング戦略
- **Lambda**: 自動スケーリング
- **DynamoDB**: オンデマンド課金
- **CloudFront**: グローバル配信
- **コスト制御**: トークン制限